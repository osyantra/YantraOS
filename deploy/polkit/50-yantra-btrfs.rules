// /etc/polkit-1/rules.d/50-yantra-btrfs.rules
// YantraOS — Microscopic privilege escalation corridor
// Consumed by polkitd(8) at daemon startup and on SIGHUP.
//
// PURPOSE:
//   Authorizes the yantra_daemon user to execute ONLY /usr/bin/btrfs
//   and /usr/bin/pacman via pkexec without an interactive password prompt.
//   This is the sole privilege escalation vector in the entire system.
//
// SECURITY CONSTRAINTS:
//   • Validates requesting user identity (yantra_daemon)
//   • Validates action identifier (org.freedesktop.policykit.exec)
//   • Validates exact absolute binary path — NO wildcards, NO directory
//     approvals, NO regex, NO glob patterns
//   • Falls through to default deny for all non-matching requests

polkit.addRule(function(action, subject) {
    // Gate 1: Only intercept pkexec authorization requests.
    if (action.id !== "org.freedesktop.policykit.exec") {
        return polkit.Result.NOT_HANDLED;
    }

    // Gate 2: Only authorize the yantra_daemon service account.
    if (subject.user !== "yantra_daemon") {
        return polkit.Result.NOT_HANDLED;
    }

    // Gate 3: Extract the exact binary path from the pkexec request.
    var program = action.lookup("program");

    // Gate 4: Permit ONLY the two explicitly sanctioned binaries.
    //   /usr/bin/btrfs  — filesystem snapshot creation and rollback
    //   /usr/bin/pacman — system package orchestration
    if (program === "/usr/bin/btrfs" || program === "/usr/bin/pacman") {
        // Log the authorized escalation for audit trail.
        polkit.log("YantraOS: Authorized pkexec for " + program +
                   " by user " + subject.user +
                   " (pid=" + subject.pid + ")");
        return polkit.Result.YES;
    }

    // Default: fall through to system-wide deny policy.
    // Any binary not explicitly listed above is rejected.
    return polkit.Result.NOT_HANDLED;
});
