# /usr/lib/tmpfiles.d/yantra.conf
# YantraOS — Volatile and persistent directory provisioning
# Consumed by systemd-tmpfiles(8) at early boot (--create) and on timer (--clean).
#
# TYPE  PATH                        MODE  USER            GROUP   AGE  ARGUMENT
# ─────────────────────────────────────────────────────────────────────────────

# 1. Volatile runtime directory for IPC socket communication.
#    Resides in tmpfs (/run) — destroyed on reboot, recreated at boot.
#    Mode 0770: owner (yantra_daemon) rwx, group (yantra) rwx, others none.
#    Houses /run/yantra/ipc.sock for TUI ↔ daemon bridge.
d     /run/yantra                  0770  yantra_daemon   yantra  -    -

# 2. Persistent Python virtual environment directory.
#    Root-owned with 0755 creates a one-way execution barrier:
#    yantra_daemon can READ and EXECUTE from the venv but cannot
#    inject persistent code — preventing supply-chain-style attacks
#    against the daemon's own runtime dependencies.
d     /opt/yantra/venv             0755  root            root    -    -

# 3. Persistent ChromaDB vector database storage.
#    The directory must be pre-created (e.g., by install.sh or a preceding 'd' line).
#    Type 'h' applies file attributes without creating the path.
#
#    CRITICAL — BTRFS +C (nodatacow) attribute:
#    SQLite databases in WAL mode perform small random writes that trigger
#    BTRFS copy-on-write on every 4K page, causing:
#      • Catastrophic fragmentation (thousands of extents per file)
#      • 10-50x write amplification on rotational and flash storage
#    The +C attribute disables COW for this directory subtree, forcing
#    in-place overwrites — restoring sane I/O performance for ChromaDB.
#
#    Note: +C only takes effect on NEW files. If migrating an existing
#    ChromaDB directory, the data must be copied (not moved) into the
#    newly attributed directory.
d     /var/lib/yantra/chroma       0750  yantra_daemon   yantra  -    -
h     /var/lib/yantra/chroma       -     -               -       -    +C
